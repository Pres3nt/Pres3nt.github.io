---

title: Hvv初级面试题--漏洞原理
categories: [Hvv行动, 面试题]

---

## SQL注入

### sql注入原理

应用程序没有对用户的输入进行验证和过滤，导致攻击者构造sql语句和后端sql语句进行拼合，从而实现非操作

 （没有对用户输入进行过滤和验证，导致用户恶意构造sql语句拼合后端sql查询语句，实现非法操作）

### sql注入的分类

有回显注入和无回显注入（盲注）

### sql注入的类型

联合注入，布尔注入，延时注入，报错注入，二次注入，宽字节注入，堆叠注入

### 报错注入函数

1. floor()（需要使用mysql_error（）函数输出mysql报错才可以）
2. extractvalue()（开启mysql数据库报错信息显示，有长度限制）
3. updatexml()（第二个参数（路径参数不符合时报错）用version或者database函数替换，输出错误的时候就会将sql代码执行）

### sql盲注原理

盲注需要根据页面的回显内容来判断是否注入正确，需要一个一个字符去猜测，比如说用length，substr函数去查询一些数据库名，数据库长度等然后根据页面的回显来判断这些命令是否正常执行

(盲注就是根据页面回显来判断注入是否正常)

### sql盲注常用函数

1. length()
2. substr()
3. ascii()
4. sleep()
5. if()

### 延时注入函数

1. sleep()（当字符满足指定要求时，延时所设置的时间长度）
2. benchmark()（将一个算式多次运算，导致时间延迟）
3. 笛卡尔积()（选定一个大表老做笛卡尔积）

### 延时注入函数sleep禁用怎么办

替换其他延迟函数，benchmark函数，如果当sleep()和benchmark()都被禁止时，可以用get lock方法进行盲注

### 宽字节注入原理

目标站点会对用户输入的特殊字符（单双引号）进行斜杠转义，斜杠的url编码是%5c，如果目标站点采用的是gbk编码，就利用%df与转义字符斜杠%5c结合成为一个汉字，从而实现单引号的逃逸。

（目标站点对特殊字符进行斜杆转义，如果目标站点采用gbk编码，可以使用%df结合斜杠成为汉字，实现单引号的逃逸）

### 堆叠注入原理

mysql数据库的sql语句的默认结束符号是以分号；结尾

目标站点没有过滤；号，导致攻击者可以利用结束符;，同时执行多条sql语句

### DNSlog注入原理

 在sql注入无法得到回显的情况下，发起DNS请求，将想要获得的数据外带出来。

攻击者提交注入语句，让数据库把需要查询的值和域名拼接起来，发生DNS查询，只要能获得DNS的日志，就能得到想要的值

（攻击者提交注入语句，注入语句告诉数据库，把需要查询的值和域名进行拼接。当发生DNS查询时，就会将数据进行外带，后续用户查看DNS解析日志，就能得到就能得到想要查询的值）

### 二次注入原理

用户向数据库中存入恶意数据，再次访问时，调用数据库的恶意数据，触发sql注入。

用户输入恶意数据，经过转义之后，注入不会触发，但是恶意数据原封不动得传入数据库中，当攻击者通过特殊语句访问数据库时，调用先前传入的恶意数据，实现sql二次注入。

### sql注入绕过WAF

1. 大小写绕过
2. 编码绕过
3. 注释绕过
4. 关键字替换绕过
5. 参数污染
6. 特殊符号
7. 内联注释 

### sql注入遇到过滤空格

1. 内联注释绕过/**/或"#"
2. 尝试%20空格编码绕过，不行的话就%09制表绕过

### sqlmap自动注入和手动注入的区别

1. 手动注入需要专业知识，自动注入无需专业知识（专业知识，无需专业知识）
2. 手动注入需要逐步尝试，观察程序响应，而自动注入可以快速检测（逐步尝试，快速检测）
3. 手动注入耗时更多，目标单一，而自动注入可以批量操作（耗时多，目标单一，批量操作）
4. 手动注入具备灵活性，而自动注入具有局限性 （灵活性高，局限性强）

### sql注入webshell的方式

知道网站的绝对路径，并且没有开启安全模式

1. 知道网站根目录的情况下，将一句话写入根目录的outfile.php文件中
2. 知道网站绝对路径的情况下用sqlmap进行os-shell提权

### Sqlmap --os-shell原理以及前提条件

- --os--shell的本质就是写入两个shell文件，其中一个可以执行命令，而另外一个，可以上传文件
- root权限，知道网站绝对路径，安全模式关闭

### sql注入预编译的原理

预编译就是将sql语句中的值用占位符？代替，即将sql语句模板化或者参数化，SQL语句先交由数据库预处理，构建语法树，再传入真正的字段值进行执行，无论后续向模板传入什么参数，这些参数仅仅被当成字符串进行查询处理。用户传入的参数不参与语法树的构建，就改变不了SQL的语法结构。

（将SQL语句中的值用占位符？替代，进行语句模板化，后续传入的参数仅仅被当成字符串进行查询处理，不参与语法树的构建，无法改变sql的语法结构）

### sql注入的危害

1. 获取数据库数据
2. 篡改数据库数据
3. 网页篡改
4. 网页挂马
5. 获取服务器权限

### sql注入的防御

1. 使用参数化查询
2. 对用户的输入进行过滤和验证
3. 最小权限原则
4. 使用准备语句
5. 避免动态拼接sql语句
6. 使用ORM框架
7. 过滤特殊敏感字符
8. 预编译（攻击指令被预编译之后就不会当成sql语句，经过编译，在mysql中就不会再次被编译了）
9. 站库分离（增加时间成本，防止通过数据库拿到webshell）

## xss漏洞

### xss漏洞的原理

攻击者可以通过闭合标签在页面中插入恶意的js代码，当用户访问页面时，浏览器解析恶意js代码，造成用户信息泄露

### xss的漏洞分类

1. 存储型xss

通过留言，评论等交互处，把攻击者的数据存储在服务器端，攻击行为伴随攻击数据一直存在。造成持久性的攻击。（经过后端，经过数据库）

1. 反射型xss

通过诱使用户访问包含恶意代码的url，当用户点击链接时，恶意代码会在受害者浏览器执行。（经过后端，不经过服务器）

1. dom型xss

纯粹发生在客户端（前端的攻击），取出和执行恶意代码都是由浏览器端完成。（不经过后端，不经过服务器）

### xss的绕过方式

1. 大小写绕过
2. 编码绕过
3. 特殊符号绕过（空格，tab键，括号，双引号等）
4. 双写绕过
5. jsfuck编码绕过

### xss的弹窗函数

1. alert()
2. confirm()
3. prompt()

###  xss的扫描工具

xsstrick

### xss的危害

1. 窃取用户cookie
2. 重定向
3. 网页钓鱼，网页挂马
4. 获取服务器或者操作系统权限

### xss的防御措施

1. 过滤用户输入
2. 对用户输入进行编码
3. 限制用户输入长度
4. 禁止js读取cookie

### xss实现文件上传的方式

1. 修改文件后缀为.html/.htm（在文件内容中插入xss代码）
2. svg中写入xss代码
3. 图片文件信息中写入xss代码

## xxe漏洞

### xxe漏洞原理

PHP开启外部实体引用功能，并且对传入的xml文档没有进行过滤和严格验证，导致可加载外部文件和代码，造成任意文件读取，命令执行等危害

### xxe漏洞攻击的构建方式

1. 直接通过DTD外部实体声明
2. 通过DTD外部实体声明引入外部实体声明
3. 通过DTD文档引入外部DTD文档，再引入外部实体声明

### xxe漏洞特点

1. xml标签
2. 响应包里的content-type：text/xml

### xxe漏洞如何利用

1. 利用file协议读取文件
2. 利用php伪协议读取文件
3. 利用http协议进行端口探测 

### xxe的盲打

1. 触发out-of-band网络交互，交互数据中可能泄露敏感数据
2. 触发xml解析错误，通过错误信息获取敏感数据

### xxe不回显

搭建远程服务器，造成数据外发

### xxe的危害

1. 任意文件读取
2. 系统命令执行
3. 远程代码执行
4. DDOS拒绝服务攻击
5. 入侵内网

### xxe的防御

1. 关闭引用外部实体功能
2. 使用验证器和解析器，清除不信任的输入数据，防止注入攻击

## 文件上传漏洞

### 文件上传漏洞原理

在文件上传功能处，没有对上传的文件进行过滤和验证，导致任意文件可上传并执行

### 文件上传判断是黑名单还是白名单过滤

1. 上传PHP后缀的文件，如果被禁止，上传pho或者pht等，如果可以则是php黑名单过滤，如果不行，就是白名单
2. 如果指定了特定类型或者特定后缀的文件上传，那么就是白名单过滤
3. 通过错误信息来判断，黑名单可能直接说不允许上传，白名单可能会说文件不符合要求

### 文件上传黑名单绕过

1. 后缀名替换
2. 双写后缀名
3. 空格绕过，点绕过
4. 上传.htaccess文件进行任意后缀名文件解析（只适用Apache框架）
5. 上传user.ini文件，利用文件包含进行绕过

### 文件上传白名单绕过

1. %00截断绕过，%00是截断符，jpg %00 PHP 服务器就会解析成为jpg
2. 文件包含绕过

### 文件上传文件内容检测绕过

1. 文件内容填充脏数据
2. 内容进行编码，关键字进行编码转换

### 文件上传功能的检测点有哪些

1. 客户端（前端）的js检测（主要检测文件后缀名）
2. 服务端（后端）的检测（MIME类型检测，文件后缀名检测，文件格式头检测）

### 文件上传漏洞的防御手段

1. 过滤常见恶意文件后缀名
2. 使用随机数修改文件名和文件路径
3. 对文件内容进行检测
4. 文件上传目录设置为不可执行
5. 采用WAF等安全防护设备

## 文件包含漏洞

### 文件包含漏洞原理

web应用程序没有正确过滤或者验证用户输入，导致攻击者可以通过构造恶意请求，将任意文件包含到web应用程序中，从而执行恶意代码或读取敏感数据等操作

### 文件包含函数

1. include()
2. include_once()
3. require()
4. require_once()

### 文件包含支持的协议

1. file协议
2. PHP伪协议：filter，input，data，zip，phar
3. http和https协议

### 文件包含漏洞的防御措施

1. 对用户输入的数据进行过滤和安全验证
2. 检查系统配置，PHP中禁用allow_url_fopen和allow_url_include选项

## 文件下载漏洞

### 文件下载漏洞原理

攻击者通过某种方式下载到了应该不被公开访问的文件，这些文件可能包含敏感信息（用户凭证，密码等）

### 文件下载漏洞的防御措施

1. 对文件下载链接进行严格的访问控制，授权用户才能访问
2. 验证用户请求的参数，防止构造请求进行攻击
3. 对应用程序安全测试，及时发现和修复漏洞
4. 过滤“.”，使得用户在url中不能回溯上级目录
5. php.ini配置open_basedir限定文件的访问范围

## 命令执行漏洞

### 命令执行漏洞原理

系统没有针对命令执行函数进行过滤和验证，将用户的输入作为系统命令参数，拼接到命令行中，导致

攻击者可以在应用程序或者系统中执行一些恶意系统命令。

### 命令执行漏洞防御措施

1. 对用户输入数据进行严格验证和过滤，防止提交恶意参数，确保输入数据不包含任何恶意命令
2. 最小权限原则，应用程序以最小的权限级别运行，减少攻击者利用漏洞获取系统权限的可能性。

## CSRF跨站请求伪造漏洞

### CSRF漏洞原理

web应用程序在用户进行敏感操作时（修改账号，密码，转账等），没有校验token或者http请求头中referer的值，导致攻击者利用普通用户身份完成攻击，通常发生在网站的表单，链接，图片等交互式元素中。

用户先前在网站A进行过登录验证，并且服务器返回了cookie存储在本地，而攻击者通过某种技术手段诱骗用户点击恶意链接访问网站B（攻击者控制的网站），然后网站B要求用户浏览器通过网站B的链接访问网站A，因为用户先前进在网站A进行过认证，所以cookie合法，因此攻击者就能以用户的身份进行一些恶意的请求攻击。

简单来说就是

控制用户浏览器去访问一个先前认证过的站点并且进行一些敏感操作，因为用户浏览器之前在该站点进行过认证，所以站点会认为这是正常用户的正常请求，就会响应攻击者的恶意请求操作。

### CSRF的利用过程

1. 构造恶意请求（请求包括转账，修改密码等操作）
2. 将恶意请求嵌入到诱骗用户点击的链接，图片等元素中
3. 用户在登录状态下访问之前认证过的站点，用户浏览器会自动发送恶意请求，恶意请求就会执行。

### CSRF漏洞的防御措施

1. 关键操作之前，先进行身份验证，如输入密码，输入验证码等(验证referer)
2. 程序中加入随机令牌机制，防止伪造请求（验证token）
3. 使用HTTP-only，禁止js读取cookie

## SSRF服务器端请求伪造漏洞

### SSRF服务端请求伪造原理

服务器提供了从其他服务器获取自我服务器数据的功能，并且没有对目标地址做过滤和限制。

攻击者无法直接访问服务器，从而借助一个中间服务器进行访问，进行服务访问限制的绕过

### SSRF的利用过程

1. 构造恶意请求（读取文件，获取机密信息）
2. 恶意请求发送给内部网络中的其他服务器，其他服务器带着恶意请求访问目标服务器
3. 目标服务器执行恶意请求将敏感信息或者控制权响应给其他服务器，其他服务器再将敏感信息或控制权返还给攻击者

### SSRF支持的协议

1. http
2. https
3. dict
4. ftp
5. File
6. php伪协议
7. gopher

### SSRF漏洞的危害

1. 主机本地敏感数据的泄露
2. 内外网主机应用程序漏洞的暴露
3. 内外网web站点漏洞的暴露

### SSRF的防御措施

1. 对外部请求进行严格验证和过滤
2. 对于网络内部请求，进行白名单校验，只允许请求已明确授权的内部服务

## 反序列化漏洞

### 反序列化漏洞原理

序列化是指将java对象转化为二进制文件的过程，反序列化指的是二进制文件转化为java对象的过程。

如果被转化的二进制文件是包含恶意代码的，转化后的对象类也是恶意的，就可能造成命令执行漏洞。

## fastjson反序列化漏洞

### fastjson反序列化漏洞原理

fastjson提供了autotype功能，在请求过程中，攻击者可以在请求包中传入恶意的json代码，并修改autotype的值指向远程调用类，通过ldap或者rmi远程服务器实现任意代码执行

### fastjson框架的判断

1. 刷新页面，抓包修改提交方式为POST，内容修改为{，不闭合，返回包里的错误信息可能存在fastjson字符
2. 利用DNS回显进行验证，@type:java.net.inet4address,观察报错识别是不是有internal server error，status=500

### fastjson的利用方法

将autotype设置为rmi/ldap的地址远程服务器，通过rmi远程服务器执行一些恶意命令

### fastjson无回显怎么办

1. 将命令执行写入到静态资源文件中，比如html和js，通过HTTP访问就可以直接看到命令执行的结果
2. 利用dnslog，进行数据外带

### fastjson不出网的利用

1. dbcp+tomcat回显（BCEL字节码利用）
2. templateslmpl利用链

### fastjson绕过waf

1. 填充空格
2. 编码绕过
3. 注释符隔离关键词

## Log4j漏洞

### log4j漏洞原理

攻击者向程序发送恶意构造的日志消息，在该消息中嵌入恶意的jndi引用，在log4j解析该消息时候，就会触发jndi查找功能，从而加载执行远程恶意代码

### log4j利用过程

1. 发布一个rmi服务，绑定一个引用类型对象，在引用对象中指定一个远含有恶意代码的类
2. 再发布一个恶意代码下载服务
3. 利用log4j漏洞触发rmi远程调用
4. 通过rmi远程调用进行恶意代码的下载和恶意代码类的执行

### log4j流量特征

${jndi:rmi

## springboot漏洞

### springboot框架的判断

1. 绿树叶图标
2. 404报错的默认页面

## weblogic漏洞

### weblogic漏洞原理

构造恶意的T3协议书和LLOP协议数据来攻击weblogic server，进而接管weblogic server

### weblogic漏洞利用方式

1. 直接T3协议发送恶意序列化Q对象
2. T3协议配合RMP或ND接口发送恶意反序列化数据
3. 通过javabean xml方式发送反序列化数据

### weblogic漏洞特征

1. 默认端口号7001
2. **From RFC 2068Hypertext Transfer Protoco的报错页面**

![img](https://cdn.jsdelivr.net/gh/Pres3nt/Typoraimages@master/images/202409010152868.png)

### weblogic的识别

1. 使用weblogic全版本扫描工具
2. weblogicsacan扫描

## redis未授权漏洞

### redis的端口号

6379

### redis未授权访问原理

密码为弱口令或者没有密码，直接暴露在公网中，并且没有添加防火墙规则避免其他非信任来源IP访问

### redis未授权的利用

1. 写webshell,需要数据库写的权限，知道web网站的路径，在web网站路径下写入php文件（内容为一句话）
2. 写ssh key，需要写入权限，攻击机生成rsa公钥，将该公钥写入目标机器/root/.ssh目录
3. 写反弹shell进计划任务，只适合centos，设置好反弹shell的Ip和端口，写进/var/spool/cron/定时任务文件中
4. 利用开源工具进行主从复制getshell

### redis未授权漏洞的防御措施

1. 修改redis配置文件，设置强密码来保护数据库
2. 禁用redis远程访问
3. 定期更新redis和操作系统补丁

## shiro漏洞

### shiro漏洞原理

1. Apache shiro框架提供了记住密码的功能
2. 用户登录成功后会将用户信息进行加密
3. 加密流程为：用户信息->序列化->AES加密->base64编码->remenberme cookie
4. 服务端收到请求会对rememberme进行base64解码，AES解密，反序列化
5. 如果攻击者知道了AES加密的密钥，把用户信息替换成了恶意命令，就能触发反序列化RCE漏洞
6. shiro版本在1.2.4以下的使用默认的AES密钥

### shiro的构造链有哪些

1. CC1~CC7
2. CB链等

### shiro漏洞只能爆破出key怎么办

1. shiro漏洞只能爆破出key，说明常见的可利用链都不可用，可以进行尝试CB链，
2. 再者使用shiro_tool工具进一步利用

### shiro漏洞不出网如何利用

1. 直接写webshell，冰蝎链接
2. 直接写内存马
3. 利用sleep函数延迟判断
4. 通过python的exp进行利用

### shiro550和721的区别

1. shiro550使用已知密钥碰撞，不需要rememberme cookie
2. shiro721加密的key是随机生成的，需要使用登录后的rememberme cookie

### shiro绕过WAF

未知http请求方法绕过

### shiro的回显方式有哪些

1. 日志记录
2. 异常抛出
3. 返回布尔值
4. HTTP响应

## struts2漏洞

### struts2漏洞

1. 文件上传
2. 命令执行
3. ognl表达式注入

### struts2漏洞特征

1. 访问的目录为.action或者.do
2. content-type的值是默认的
3. 返回的页面可能会有struct2等字样
4. ognl表达式的请求参数会有${},%{}字符

## 菜刀流量特征

1. 伪造XFF头，每次利用的XFF头都不同
2. 存在eval，assert等等命令执行函数
3. base64编码，解码出来存在参数z0z1z2
4. @int_set('display_errors')字符串

## 蚁剑流量特征

1. base64编码，特征与菜刀极为相似
2. 请求体只经过URL编码
3. @ini_set（display_errors,0）
4. 参数大多数以0x开头

## 冰蝎流量特征

- 3.0：

1. 内置16个UA头
2. 取消动态密钥获取
3. AES密钥变成md5("pass")[0:16]

- 4.0:

1. 内置10个UA头
2. 固定的请求头和响应头
3. 默认密钥为连接密码32位md5值的前16位
4. 默认密码是rebeyond

## 哥斯拉流量特征

1. cookie信息的最后会存在一个分号
2. 使用ICMP协议发送数据报文，并且ICMP报文的payload长度固定为92字节
3. 数据包较大，base64编码
4. 如果请求体采用base64编码，响应体也是base64编码
5. 响应包的结构体征为：md5前16位+base64+md5后16位

## 挖矿程序特征

当服务器或CPU使用率接近或者超过100%时，并且持续高居不下导致服务器或者PC端操作延缓

## Linux系统排查挖矿程序

（top找，PID查，文件分析，停止服务，删除文件，清理定时任务）

1. 使用TOP命令查看系统性能，找出消耗资源较高的进程PID
2. 利用ps -ef -p PID命令找出新系统进程的详细信息
3. 根据进程详细信息进入文件位置，进行文件分析
4. 停止服务，systemctl stop *service
5. 删除文件 rm -rf abnormal_file（可使用find/ -name abnormal_file 查找出系统中所有的恶意文件）
6. 清理定时任务 crontab -e

## windows系统排查挖矿程序

1. 启动任务管理器
2. 找到资源管理器
3. 找到占用CPU资源较高的进程或者服务，获取其PID信息
4. 根据PID信息，找到文件位置，进行文件分析，确认是否为挖矿程序
5. 确认挖矿程序之后，先对其备份，然后关闭对应服务与进程，删除其对应的定时任务，最后删除文件。
6. 删除文件之后，再次查询定时任务，进程和服务，最好是间隔一定时间段之后再复查一次。

## 常见的未授权漏洞

1. mongoDB
2. redis
3. memcached
4. JBOSS
5. VNC
6. docker
7. zookeeper
8. rsync